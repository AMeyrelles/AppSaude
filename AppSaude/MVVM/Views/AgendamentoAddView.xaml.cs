using AppSaude.MVVM.ViewModels;
using AppSaude.Services;
using Plugin.LocalNotification;

namespace AppSaude.MVVM.Views;

public partial class AgendamentoAddView : ContentPage
{
	private readonly IService _services;

    private readonly List<DateTime> _agendamentoList = new List<DateTime>();
    public AgendamentoAddView(IService services)
	{
        InitializeComponent();
        _services = services;

        var viewModel = new AgendamentoViewModel(services);
        BindingContext = viewModel;
    }   

    //Botão para salvar o agendamento
    private async void btnAddAgendamento_Clicked(object sender, EventArgs e)
    {
        // Obtém a data e a hora selecionadas
        DateTime selectedDate = datePickerControl.Date;
        TimeSpan selectedTime = timePickerControl.Time;

        // Combina a data e a hora
        DateTime agendamentoDateTime = selectedDate.Date.Add(selectedTime);

        // Verifica se a data selecionada é no passado
        if (selectedDate < DateTime.Now.Date)
        {
            await DisplayAlert("Erro", "A data selecionada não pode ser no passado.", "OK");
            return;
        }

        //Dispara notificação
        if (selectedDate.Date == agendamentoDateTime.Date)
        {
            var notification = new NotificationRequest
            {
                NotificationId = 102,
                Title = "ALERTA!",
                Description = "Você tem um agendamento marcado HOJE!",
                Schedule = new NotificationRequestSchedule
                {
                    NotifyTime = agendamentoDateTime
                },
                Android = new Plugin.LocalNotification.AndroidOption.AndroidOptions
                {
                    AutoCancel = true,
                    IconSmallName = { ResourceName = "bell.png" }
                }
            };

           await LocalNotificationCenter.Current.Show(notification);
        }

        // Adiciona o agendamento à lista (opcional)
        _agendamentoList.Add(selectedDate);

        // Configura a notificação
        await VerifyPermissionsAsync();
        ScheduleNotificationDay(selectedDate);
    }

    //Dispara notificação
    private void ScheduleNotificationDay(DateTime agendamentoDateTime)
    {
        try
        {
            var notification = new NotificationRequest
            {
                NotificationId = 101,
                Title = "ALERTA!",
                Description = "Não esqueça do seu agendamento HOJE!",
                Schedule = new NotificationRequestSchedule
                {
                    NotifyTime = agendamentoDateTime
                },
                Android = new Plugin.LocalNotification.AndroidOption.AndroidOptions
                {
                    AutoCancel = true,
                    IconSmallName = { ResourceName = "appicon.svg" }
                }
            };

            LocalNotificationCenter.Current.Show(notification);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao agendar a notificação: {ex.Message}");
        }
    }

    //Verificar a permissão do usuario
    private async Task VerifyPermissionsAsync()
    {
        try
        {
            var status = await Permissions.CheckStatusAsync<Permissions.PostNotifications>();

            if (status != PermissionStatus.Granted)
            {
                await DisplayAlert("Alerta", "Aceite para receber notificações!", "OK");
                status = await Permissions.RequestAsync<Permissions.PostNotifications>();
            }

            if (status == PermissionStatus.Granted)
            {
                Console.WriteLine("Permissão para notificações concedida.");
            }
            else
            {
                await App.Current.MainPage.DisplayAlert("Alerta!", "Permissão para notificações negada.", "OK");
                await DisplayAlert("Alerta", "Permissão para notificações NEGADA!", "OK");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao verificar permissões: {ex.Message}");
        }
    }

    //Botão de Cancelar/Retornar
    private async void btnCancelarAgendamento_Clicked(object sender, EventArgs e)
    {
        await Navigation.PopAsync();
    }


}